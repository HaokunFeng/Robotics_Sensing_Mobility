Pick and Place tasks and Arm Motion Planning
===

## Creating a robotic arm trajectory from waypoints
### Trajectory planning with Bezier curve in Cartesian space for Kinova arm
There are many trajectory planning strategies among which Bezier curve is one that is easy to apply and ideal for applications requiring a smooth trajectory. A Bezier curve is a mathematical curve defined by a series of control points, which determine the shape of the curve. The curve starts at the first control point and ends at the last control point, but it can bend and twist in any way that is defined by the other control points.


<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/bezier2.png" alt=""></center>
<p align="center">Cubic Bezier curve with four contro</p>

- Guide the Kinova arm to follow a trajectory based on a Bezier
curve, moving it from the Home position to the Vertical position.
- Using BezierCurveCalculator.xlsx to calculate interpolate points along the Bezier curve based on 4 input control points, with two possible output versions containing 11 or 21 points.

<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/lab71.png"></center>
<p align="center">Bezier Curve</p>

- Then spawn a robot in an empty world: ``$ roslaunch kortex_gazebo spawn_kortex_robot.launch arm:=gen3 gripper:=robotiq_2f_85``
- Use RViZ to select 4 points to generate a trajectory: Start, End, and 2 mid points. Use Home position as Start and Vertical as End. You need to find two intermediate poses (collect pose information from \$ rosrun tf tf\_echo base\_link tool\_frame). The trajectories generated on the file are normalized in time ($0 \leqslant t \leqslant 1$). 
- Select the version of your choice (11 or 21 points) and paste that information into you data.csv file. Once the data.csv file has been modified you can run the python script (plot\_trajectory.py) to plot the points in 3D for visualization.

> {Tip:} : you should replace (Ctrl + H) the tab spacing with a comma (,)

- We have handled the position of the end-effector’s pose along the trajectory with the Bezier curve. Next, we will need to generate smooth changes between the orientations that differ at positions.

<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/lab72.png"></center>

- For quaternion interpolation we will use one class of the python module pyquaternion. You can install it using pip: ``$ pip install pyquaternion``

- The typical usage of pyquaternion that best suits our application is by declaring one quaternion for each start and end pose, and use one method that uniformly interpolates values in between:
    ```
    >> from pyquaternion import Quaternion

    >> qStart = Quaternion(w=<value>, x=<value>, y=<value>, z=<value>)

    >> qEnd = Quaternion(w=<value>, x=<value>, y=<value>, z=<value>)

    >> qList = Quaternion.intermediates(qStart, qEnd, <numIntermediates>, include_endpoints=True)
    ```
- This chunk of the code is in trajectory\_from\_csv.py. This file combines the two composition of trajectory generation - positions along the path and quaternion interpolation. You can run the script and visualize the changes in both RViZ and Gazebo.

> {Tip}: Execute the command \$ export ROS\_NAMESPACE="/my\_gen3/" on your terminal to be able to use pick\_and\_place.py class from terminal or import in different python file.

- Example control points used to generate a (Bezier curve) trajectory to go from Home to Vertical position:

    | Bezier Curve | pStart | p1 | p2 | pEnd |
    | --- | --- | --- | --- | --- |
    | x | 0.576 | 0.213 | -0.110 | 0.001 |
    | y | 0.002 | 0.478 | 0.255 | -0.025 |
    | z | 0.434 | 0.971 | 1.216 | 1.307 |


<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/Figure_1.png"></center>
<p align="center">Path generated by Bezier Curve</p>

- Optimize Visualization Experience:

<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/Figure_2.png"></center>
<p align="center">Optimize Visualization Experience</p>

## Pick and Place task with obstacle avoidance
Apply all of the elements above to a sorting task, which involves picking up cubes of different colors and placing them on top of the corresponding bins. It should be noted that the simulated environment includes walls that require careful planning to avoid collisions.

<center><img src="https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/lab73.png"></center>
<p align="center">The planning scene</p>

- In the start\_gazebo.launch file (roscd kortex\_gazebo/launch) add the following argument to open the new generated world: ``<arg name="world_name" value="<path to your Lab7_code folder>/sorting_world.sdf"/>``
- In the spawn\_kortex\_robot.launch file, modify the line that starts the RViZ node to include the configuration file provided in the lab materials:
    ```
    <node name="rviz" pkg="rviz" type="rviz" args="-d 
    <path to your Lab7_code folder>/pickandplace.rviz" if="$(arg start_rviz)"/>
    ```

- Once completed those changes, run the following command:
    ```
    $ export GAZEBO_MODEL_PATH=$GAZEBO_MODEL_PATH:<path to your Lab7_code folder>
    $ roslaunch kortex_gazebo spawn_kortex_robot.launch arm:=gen3 gripper:=robotiq_2f_85 z0:=0.775
    ```


The process for sorting the green cube can involve the same steps as the pick-and-place task:

    1. Reach position above the center of the object to be picked with gripper oriented
    2. Adjust gripper to open or semi-open state.
    3. Decrease the end-effector’s z-value position
    4. Close gripper to grasp object.
    5. Reach position above the desired location to place the object with gripper oriented.
    6. Decrease the end-effector’s z-value position
    7. Open gripper to release object.
    8. Increase the end-effector’s z-value position to clear the object
    9. Return to home position.

- For sorting the cubes, we should consider finding waypoints that won't hit the walls, and generating trajectories that guarantee a successful movement between picking and placing.

[![](https://raw.githubusercontent.com/HaokunFeng/Robotics_Sensing_Mobility/main/7_Pick_and_Place_Tasks_and_Arm_Motion_Planning/assets/Figure_3.png)](https://drive.google.com/file/d/1fXucyTXoBMOyslCYr-TX6KnZwfQu4x0R/view?usp=sharing)